name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: |
          # Nettoyer le cache npm et supprimer node_modules
          echo "=== Nettoyage du cache et suppression des dépendances existantes ==="
          npm cache clean --force
          rm -rf node_modules
          rm -f package-lock.json
          
          # Installer les dépendances principales sans les scripts
          echo "=== Installation des dépendances principales ==="
          npm install --legacy-peer-deps --no-optional --ignore-scripts
          
          # Installer patch-package globalement pour l'utiliser dans les étapes suivantes
          echo "=== Installation de patch-package ==="
          npm install -g patch-package@8.0.0
          
          # Vérifier que les dépendances sont correctement installées
          echo "=== Vérification des dépendances installées ==="
          npm list --depth=0

      - name: Create and apply patches
        run: |
          echo "=== Création du dossier patches ==="
          mkdir -p patches
          
          echo "=== Création du patch pour react-beautiful-dnd ==="
          cat > patches/react-beautiful-dnd+13.1.1.patch << 'EOL'
          --- node_modules/react-beautiful-dnd/package.json
          +++ node_modules/react-beautiful-dnd/package.json
          @@ -1,5 +1,5 @@
           {
          -  "name": "react-beautiful-dnd",
          +  "name": "patched-react-beautiful-dnd",
             "version": "13.1.1",
             "description": "Beautiful, accessible drag and drop for lists with React",
             "license": "Apache-2.0",
          @@ -7,7 +7,7 @@
             "bugs": "https://github.com/atlassian/react-beautiful-dnd/issues",
             "repository": "git@github.com:atlassian/react-beautiful-dnd.git",
             "scripts": {
          -    "postinstall": "node ./scripts/postinstall/check-peer-dependencies.js"
          +    "postinstall": "echo 'Skipping postinstall for react-beautiful-dnd'"
             },
             "dependencies": {
               "css-box-model": "1.2.1",
          EOL
          
          echo "=== Application du patch ==="
          cd node_modules/react-beautiful-dnd
          patch -p1 < ../../patches/react-beautiful-dnd+13.1.1.patch || echo "Le patch a peut-être déjà été appliqué"
          cd ../..
          
          echo "=== Vérification du patch ==="
          if grep -q "Skipping postinstall" node_modules/react-beautiful-dnd/package.json; then
            echo "✅ Patch appliqué avec succès"
          else
            echo "⚠️ Le patch n'a pas été appliqué correctement"
            exit 1
          fi

      - name: Build
        run: |
          echo "Building with base URL: /gestion-projet/"
          # Utiliser --no-optional pour éviter les problèmes avec les dépendances optionnelles
          npm run build -- --legacy-peer-deps --no-optional
          echo "=== Contenu du dossier dist ==="
          ls -la dist/
          echo "=============================="

      - name: Create .nojekyll
        run: touch ./dist/.nojekyll

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.5.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: dist
          clean: true
          commit-message: 'Deploy: Update site content'
          force: true
